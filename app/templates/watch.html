<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ video.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
</head>
<body>
  <header><a href="/">YourTube</a> ‚Äî <a href="/profile/{{ user.username if user else '' }}">{{ user.username if user else '' }}</a></header>

  <main>
    <h1>{{ video.title }}</h1>
    <video width="800" controls>
      <source src="{{ video.cloudinary_url }}" type="video/mp4">
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç video.
    </video>

    {% if thumb_url %}
      <img src="{{ thumb_url }}" alt="thumb" style="width:320px;margin-top:8px;">
    {% endif %}

    <p>{{ video.description }}</p>
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: <span id="views">{{ video.views }}</span></p>

    <div>
      <button id="like" data-id="{{ video.id }}" data-value="1">üëç <span id="likes-count">{{ video.likes }}</span></button>
      <button id="dislike" data-id="{{ video.id }}" data-value="-1">üëé <span id="dislikes-count">{{ video.dislikes }}</span></button>
    </div>

    <section id="comments">
      <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
      <form action="/watch/{{ video.id }}/comment" method="post">
        <textarea name="content" required></textarea><br>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>

      {% for c in comments %}
        <div class="comment">
          <strong>{{ c.user.username }}</strong> ‚Äî {{ c.created_at.strftime('%d.%m.%Y %H:%M') }}<br>
          <p>{{ c.content }}</p>
        </div>
      {% endfor %}
    </section>
  </main>

  <script>
    async function react(id, value) {
      const form = new FormData();
      form.append('target_type','video');
      form.append('target_id', id);
      form.append('value', value);
      const resp = await fetch('/api/react', { method: 'POST', body: form });
      if (!resp.ok) {
        alert('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏');
        return null;
      }
      return await resp.json();
    }

    document.getElementById('like').addEventListener('click', async function(){
      const id = this.getAttribute('data-id');
      const res = await react(id, 1);
      if (res) {
        document.getElementById('likes-count').textContent = res.likes;
        document.getElementById('dislikes-count').textContent = res.dislikes;
      }
    });
    document.getElementById('dislike').addEventListener('click', async function(){
      const id = this.getAttribute('data-id');
      const res = await react(id, -1);
      if (res) {
        document.getElementById('likes-count').textContent = res.likes;
        document.getElementById('dislikes-count').textContent = res.dislikes;
      }
    });
  </script>
</body>
</html>
