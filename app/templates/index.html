<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>YourTube ‚Äî –ì–ª–∞–≤–Ω–∞—è</title>
  <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
</head>
<body>
  <header>
    <h1><a href="/">YourTube</a></h1>
    {% if user %}
      –ü—Ä–∏–≤–µ—Ç, <a href="/profile/{{ user.username }}">{{ user.username }}</a> | <a href="/logout">–í—ã–π—Ç–∏</a>
    {% else %}
      <a href="/login">–í–æ–π—Ç–∏</a> | <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
    {% endif %}
    <a href="/upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</a>
  </header>

  <main>
    <h2>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ</h2>
    <div class="grid">
      {% for v in videos %}
        <div class="card">
          <a href="/watch/{{ v.id }}">
            <img src="{{ v.thumb_url }}" alt="thumb" class="thumb">
          </a>
          <div class="meta">
            <a href="/watch/{{ v.id }}"><strong>{{ v.title }}</strong></a>
            <div class="stats">{{ v.uploader }} ‚Ä¢ {{ v.views }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
            <div class="reactions">
              <button class="like-btn" data-id="{{ v.id }}" data-value="1">üëç <span class="count">{{ v.likes }}</span></button>
              <button class="dislike-btn" data-id="{{ v.id }}" data-value="-1">üëé <span class="count">{{ v.dislikes }}</span></button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </main>

  <script>
    async function react(id, value) {
      const form = new FormData();
      form.append('target_type','video');
      form.append('target_id', id);
      form.append('value', value);
      const resp = await fetch('/api/react', { method: 'POST', body: form });
      if (!resp.ok) return;
      const json = await resp.json();
      return json;
    }

    document.addEventListener('click', async (e) => {
      if (e.target.closest('.like-btn') || e.target.closest('.dislike-btn')) {
        const btn = e.target.closest('button');
        const id = btn.getAttribute('data-id');
        const value = parseInt(btn.getAttribute('data-value'));
        const res = await react(id, value);
        if (res && res.likes !== undefined) {
          // update counts beside this card
          const card = btn.closest('.card');
          if (card) {
            card.querySelector('.like-btn .count').textContent = res.likes;
            card.querySelector('.dislike-btn .count').textContent = res.dislikes;
          }
        }
      }
    });
  </script>
</body>
</html>
